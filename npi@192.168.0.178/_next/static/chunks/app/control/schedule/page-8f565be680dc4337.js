(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4430],{78:function(e,s,n){Promise.resolve().then(n.bind(n,9353))},9353:function(e,s,n){"use strict";n.r(s);var r=n(7437),t=n(2265),a=n(6820),l=n.n(a),i=n(2395);n(5392);var c=n(225),o=n(2031),d=n(5831),m=n(3611),h=n(7532),u=n(6005),x=n(708),v=n(1465),j=n(453),p=n(307),f=n(5217),g=n(9203),N=n(3086),C=n(5344),b=n(6577);s.default=()=>{let[e,s]=(0,t.useState)(""),[n,a]=(0,t.useState)("text-warning"),[y,D]=(0,t.useState)([]),[_,T]=(0,t.useState)([]),[S,w]=(0,t.useState)(!1),[k,O]=(0,t.useState)(!1),[E,z]=(0,t.useState)(""),[A,M]=(0,t.useState)(!1),Q=(0,t.useRef)(null),q=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],B={id:"",customName:"",deviceName:"",mac:"",address:"",device_bus:"",part_number:"",startDay:"Mon",endDay:"Sun",controls:[{pin:1,customName:"",onTime:"08:00",offTime:"17:00"}]},[Z,P]=(0,t.useState)(B),F={enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:1,allowInput:!0},I="response_control_scheduler",J="mqtt_config/response_mac",L="command_device_i2c",R=(0,t.useCallback)(function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"command_control_scheduler",n=(0,C.Oh)();n&&n.connected?n.publish(s,JSON.stringify(e),e=>{e&&console.error("Failed to publish message:",e)}):console.error("MQTT client not connected for publishing.")},[]),V=(0,t.useCallback)(()=>{R({action:"get"})},[R]),G=(0,t.useCallback)(()=>{R({action:"get_mac_address"},"mqtt_config/get_mac_address")},[R]),H=(0,t.useCallback)(()=>{R({action:"get_devices"})},[R]);(0,t.useEffect)(()=>{let e=null;try{(e=(0,C.kS)()).on("connect",()=>{console.log("Connected to MQTT Broker via lib/mqttClient"),s("Connected"),a("text-success"),e.subscribe("service/response",{qos:0}),e.subscribe(I),e.subscribe(J),e.subscribe(L),V()}),e.on("error",e=>{console.error("MQTT Error (from component):",e.message),s("Error: "+e.message),a("text-danger")}),e.on("close",()=>{console.log("MQTT Connection closed (from component)"),s("Disconnected from MQTT Broker"),a("text-danger")}),e.on("message",(e,n)=>{console.log("Message arrived:",n.toString());try{let r=JSON.parse(n.toString());e===J&&r.mac?P(e=>({...e,mac:r.mac})):e===L&&r.availableDevices?D(r.availableDevices):r.result?(s(r.result),"success"===r.result?l().fire({icon:"success",title:"Success",text:r.message||"Operation completed successfully."}):"error"===r.result&&l().fire({icon:"error",title:"Error",text:r.message||"There was an error processing the request."})):Array.isArray(r.devices)&&r.devices.length>0?(T(r.devices),w(r.autoControl)):r.availableDevices&&Array.isArray(r.availableDevices)?D(r.availableDevices):console.log("Received payload does not match expected structure or contains no relevant data.")}catch(e){console.error("Error parsing message:",e),l().fire({icon:"error",title:"Error",text:"There was an error parsing the MQTT message."})}})}catch(e){console.error("Error connecting MQTT:",e.message),s("Connection failed: "+e.message),a("text-danger")}return()=>{e&&(e.removeAllListeners("connect"),e.removeAllListeners("error"),e.removeAllListeners("close"),e.removeAllListeners("message"))}},[V,J,I,L]);let K=(0,t.useMemo)(()=>[...new Set(y.map(e=>e.name))],[y]),showEditDeviceModal=e=>{O(!0),P({...e,deviceName:e.deviceName||""}),z(e.deviceName||""),H(),M(!0)},deleteDevice=e=>{R({action:"delete",data:{id:e}}),T(s=>s.filter(s=>s.id!==e)),l().fire({icon:"success",title:"Device Deleted!",showConfirmButton:!0,confirmButtonText:"OK"}).then(()=>{restartService()})},removeControl=e=>{P(s=>({...s,controls:s.controls.filter(s=>s!==e)}))},restartService=()=>{let e=JSON.stringify({action:"restart",services:["modular_i2c.service","scheduler_control.service"]}),s=(0,C.Oh)();if(s&&s.connected)s.publish("service/command",e);else{console.error("MQTT client not connected to send restart command."),l().fire({title:"Connection Error",text:"MQTT client is not connected. Cannot send restart command.",icon:"error"});return}l().fire({title:"Restarting Services",text:"Please wait while the services are being restarted...",icon:"info",allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{l().showLoading()}})},handleControlChange=(e,s,n)=>{let r=[...Z.controls];r[e][s]=n,P(e=>({...e,controls:r}))},U=(0,t.useCallback)(()=>{let e=(0,C.Oh)();e&&e.connected?e.publish(L,JSON.stringify({command:"getDataI2C"})):console.error("MQTT client not connected to send getDataI2C command.")},[L]);return(0,r.jsxs)(p.kV,{children:[(0,r.jsxs)("header",{className:"flex h-16 items-center justify-between border-b px-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.vP,{className:"-ml-1"}),(0,r.jsx)(f.Z,{orientation:"vertical",className:"mr-2 h-4"}),(0,r.jsx)(g.Z,{className:"h-5 w-5"}),(0,r.jsx)("h1",{className:"text-lg font-semibold",children:"Device Scheduler Control"})," "]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(b.Z,{})," ",(0,r.jsx)(m.z,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:U,children:(0,r.jsx)(N.Z,{})}),(0,r.jsx)(m.z,{size:"sm",variant:"default",onClick:()=>{O(!1),P(B),z(""),H(),G(),M(!0)},children:"Add Device"})]})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[" ",(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("div",{children:(0,r.jsx)(m.z,{size:"sm",onClick:V,className:"mr-2",children:"Get Configuration"})}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(j.r,{checked:S,onCheckedChange:e=>{w(e),R({action:"update_autoControl",data:{autoControl:e}})},id:"auto-control"}),(0,r.jsx)(v._,{htmlFor:"auto-control",className:"ml-3 mt-2",children:"Control State"})]})})]}),(0,r.jsx)("h5",{className:"text-lg font-semibold mb-3",children:"Control Scheduler"}),_.length>0?(0,r.jsxs)(u.iA,{children:[(0,r.jsx)(u.xD,{children:(0,r.jsxs)(u.SC,{children:[(0,r.jsx)(u.ss,{children:"#"}),(0,r.jsx)(u.ss,{children:"Custom Name"}),(0,r.jsx)(u.ss,{children:"Address"}),(0,r.jsx)(u.ss,{children:"Device Bus"}),(0,r.jsx)(u.ss,{children:"Days"}),(0,r.jsx)(u.ss,{children:"Controls"}),(0,r.jsx)(u.ss,{children:"Actions"})]})}),(0,r.jsx)(u.RM,{children:_.map((e,s)=>(0,r.jsxs)(u.SC,{children:[(0,r.jsx)(u.pj,{children:s+1}),(0,r.jsx)(u.pj,{children:e.customName}),(0,r.jsx)(u.pj,{children:e.address}),(0,r.jsx)(u.pj,{children:e.device_bus}),(0,r.jsxs)(u.pj,{children:[(0,r.jsx)("strong",{children:"Active Days: "})," ",e.startDay," - ",e.endDay]}),(0,r.jsx)(u.pj,{children:(0,r.jsx)("ul",{children:e.controls.map(e=>(0,r.jsxs)("li",{className:"flex justify-between text-sm",children:[(0,r.jsxs)("span",{children:["Name: ",(0,r.jsx)("span",{className:"font-bold",children:e.customName})," - Pin:"," ",(0,r.jsx)("span",{className:"font-bold",children:e.pin})]}),(0,r.jsxs)("span",{children:["Turn On: ",(0,r.jsxs)("span",{className:"font-bold",children:[e.onTime," "]})," - Turn Off:"," ",(0,r.jsx)("span",{className:"font-bold",children:e.offTime})]})]},e.pin))})}),(0,r.jsxs)(u.pj,{children:[(0,r.jsx)(m.z,{size:"sm",variant:"outline",onClick:()=>showEditDeviceModal(e),className:"mr-2",children:"Edit"}),(0,r.jsx)(m.z,{size:"sm",variant:"destructive",onClick:()=>deleteDevice(e.id),children:"Delete"})]})]},e.id))})]}):(0,r.jsxs)("div",{className:"text-center py-4",children:[(0,r.jsx)("p",{className:"text-gray-500",children:'No devices found. Click "Get Configuration" to load or "Add Device" to create one.'}),(0,r.jsx)(m.z,{variant:"link",onClick:V,children:"Get Configuration"})]})]})]}),(0,r.jsx)(o.Vq,{open:A,onOpenChange:M,children:(0,r.jsxs)(o.cZ,{className:"max-w-md md:max-w-lg",children:[(0,r.jsx)(o.fK,{children:(0,r.jsxs)(o.$N,{className:"flex items-center",children:[k?"Edit Device":"Add Device",(0,r.jsx)(x.C,{variant:"secondary",onClick:H,className:"ml-2 cursor-pointer",children:"Get Devices"})]})}),(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault();let s={...Z};k||(s.id=(0,c.Z)()),R({action:k?"set":"add",data:JSON.parse(JSON.stringify(s))}),M(!1),l().fire({icon:"success",title:k?"Device updated!":"Device added!",showConfirmButton:!0,confirmButtonText:"OK"}).then(()=>{restartService()})},ref:Q,children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 py-4",children:[(0,r.jsxs)("div",{className:"col-span-1",children:[(0,r.jsx)(v._,{htmlFor:"device_name",children:"Device Name"}),(0,r.jsxs)(h.Ph,{value:E,onValueChange:e=>{z(e);let s=y.find(s=>s.name===e);s?P(n=>({...n,deviceName:e,address:s.address,device_bus:s.device_bus,part_number:s.part_number})):P(s=>({...s,deviceName:e,address:"",device_bus:"",part_number:""}))},required:!0,children:[(0,r.jsx)(h.i4,{className:"w-full",children:(0,r.jsx)(h.ki,{placeholder:"Select a device"})}),(0,r.jsx)(h.Bw,{children:K.map(e=>(0,r.jsx)(h.Ql,{value:e,children:e},e))})]})]}),(0,r.jsxs)("div",{className:"col-span-1",children:[(0,r.jsx)(v._,{htmlFor:"custom_name",children:"Custom Name"}),(0,r.jsx)(d.I,{id:"custom_name",value:Z.customName,onChange:e=>P(s=>({...s,customName:e.target.value})),placeholder:"Enter Custom Name",required:!0})]}),(0,r.jsxs)("div",{className:"col-span-1",children:[(0,r.jsx)(v._,{htmlFor:"startDay",children:"Start Day"}),(0,r.jsxs)(h.Ph,{value:Z.startDay,onValueChange:e=>P(s=>({...s,startDay:e})),required:!0,children:[(0,r.jsx)(h.i4,{className:"w-full",children:(0,r.jsx)(h.ki,{placeholder:"Select start day"})}),(0,r.jsx)(h.Bw,{children:q.map(e=>(0,r.jsx)(h.Ql,{value:e,children:e},e))})]})]}),(0,r.jsxs)("div",{className:"col-span-1",children:[(0,r.jsx)(v._,{htmlFor:"endDay",children:"End Day"}),(0,r.jsxs)(h.Ph,{value:Z.endDay,onValueChange:e=>P(s=>({...s,endDay:e})),required:!0,children:[(0,r.jsx)(h.i4,{className:"w-full",children:(0,r.jsx)(h.ki,{placeholder:"Select end day"})}),(0,r.jsx)(h.Bw,{children:q.map(e=>(0,r.jsx)(h.Ql,{value:e,children:e},e))})]})]})]}),(0,r.jsxs)("div",{className:"mb-3",children:[(0,r.jsx)("h5",{className:"text-md font-semibold mb-2",children:"Controls"}),(0,r.jsx)("div",{className:"max-h-60 overflow-y-auto pr-2",children:Z.controls.map((e,s)=>(0,r.jsxs)("div",{className:"mb-4 p-3 border rounded-md",children:[(0,r.jsx)("hr",{className:"my-2"}),(0,r.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-center mb-2",children:[(0,r.jsx)("div",{className:"col-span-9",children:(0,r.jsx)(d.I,{value:e.customName,onChange:e=>handleControlChange(s,"customName",e.target.value),placeholder:"Custom Name for control"})}),(0,r.jsx)("div",{className:"col-span-3 text-right",children:(0,r.jsx)(m.z,{type:"button",variant:"destructive",size:"sm",onClick:()=>removeControl(e),children:"Remove"})})]}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(v._,{children:"Pin"}),(0,r.jsx)(d.I,{type:"number",value:e.pin,onChange:e=>handleControlChange(s,"pin",parseInt(e.target.value)),placeholder:"Pin",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(v._,{children:"Start Time"}),(0,r.jsx)(i.Z,{options:F,value:e.onTime,onChange:e=>{let[n]=e;return handleControlChange(s,"onTime",n?i.Z.formatDate(n,"H:i"):"")},className:"w-full p-2 border rounded-md",placeholder:"On Time"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(v._,{children:"End Time"}),(0,r.jsx)(i.Z,{options:F,value:e.offTime,onChange:e=>{let[n]=e;return handleControlChange(s,"offTime",n?i.Z.formatDate(n,"H:i"):"")},className:"w-full p-2 border rounded-md",placeholder:"Off Time"})]})]})]},s))})]}),(0,r.jsxs)("div",{className:"flex justify-end mt-4",children:[(0,r.jsx)(m.z,{type:"button",variant:"secondary",size:"sm",onClick:()=>{let e=new Set(Z.controls.map(e=>e.pin)),s=1;for(;e.has(s);)s++;P(e=>({...e,controls:[...e.controls,{pin:s,customName:"",onTime:"08:00",offTime:"17:00"}]}))},className:"mr-2",children:"Add Control"}),(0,r.jsxs)(m.z,{type:"submit",size:"sm",children:[k?"Update":"Add"," Device"]})]})]})]})})]})}}},function(e){e.O(0,[2793,9461,9848,5348,2995,5533,307,7742,2971,2472,1744],function(){return e(e.s=78)}),_N_E=e.O()}]);